#' @include features.R
NULL

#' @rdname feature-finding
#' @export
featuresEnviPick <- setClass("featuresEnviPick", contains = "features")

#' @details \code{findFeaturesEnviPick} uses the
#'   \code{\link[enviPick]{enviPickwrap}}. function from the \pkg{enviPick} R
#'   package to extract features.
#'
#' @note \code{findFeaturesEnviPick} Requires analysis files to be in the
#'   \code{mzXML} format.
#'
#' @rdname feature-finding
#' @export
findFeaturesEnviPick <- function(analysisInfo, ...)
{
    assertAnalysisInfo(anaInfo, "mzXML")
    
    ret <- featuresEnviPick(analysisInfo = analysisInfo)

    cat("Finding features with enviPick...\n===========\n")

    fts <- list()
    for (i in seq_len(nrow(analysisInfo)))
    {
        printf("Loading features with envipick from analysis '%s'... \n", analysisInfo$analysis[i])

        # UNDONE: use makeFileHash instead?
        hash <- makeHash(analysisInfo$analysis[i], analysisInfo$path[i], list(...))
        f <- loadCacheData("featuresEnviPick", hash)

        if (is.null(f))
        {
            fp <- getMzXMLAnalysisPath(analysisInfo$analysis[i], analysisInfo$path[i])
            ep <- enviPickwrap(fp, ...)
            f <- importEnviPickPeakList(ep$Peaklist)
            saveCacheData("featuresEnviPick", f, hash)
        }

        fts[[analysisInfo$analysis[i]]] <- f

        cat("Done!\n")
    }

    ret@features <- fts

    cat("\n===========\nDone!\n")

    return(ret)
}

#' @details \code{importFeaturesEnviMass} imports features from a project
#'   generated by the \pkg{enviMass} package.
#'
#' @param enviProjPath The path of the enviMass project.
#' @rdname feature-finding
#' @export
importFeaturesEnviMass <- function(analysisInfo, enviProjPath)
{
    cat("Importing features from enviMass...\n")

    ret <- featuresEnviPick(analysisInfo = analysisInfo)

    fts <- list()
    scount <- nrow(analysisInfo)
    prog <- txtProgressBar(0, scount, style = 3)

    for (i in seq_len(nrow(analysisInfo)))
    {
        load(file.path(enviProjPath, "peaklist", analysisInfo$analysis[i])) # load into 'peaklist'
        fts[[analysisInfo$analysis[i]]] <- importEnviPickPeakList(as.data.frame(peaklist))
        setTxtProgressBar(prog, i)
    }

    ret@features <- fts

    setTxtProgressBar(prog, scount)
    close(prog)

    cat("Done!\n")

    return(ret)
}

importEnviPickPeakList <- function(peaklist)
{
    ft <- as.data.table(peaklist)
    setnames(ft, c("m/z", "max_int", "sum_int", "RT", "minRT", "maxRT", "peak_ID"),
             c("mz", "intensity", "area", "ret", "retmin", "retmax", "ID"))

    # Estimate mzrange from variance
    s <- sqrt(ft$`var_m/z`)
    ft[, mzmin := mz - 2*s]
    ft[, mzmax := mz + 2*s]

    return(ft[, c("ID", "ret", "mz", "intensity", "area", "retmin", "retmax", "mzmin", "mzmax")])
}
