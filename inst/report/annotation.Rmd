<style>
.annotationClass {
    display: none;
}
</style>

<script>`r readAllFile(system.file("js", "utils-report.js", package = "patRoon"))`</script>

Annotation {data-orientation=rows}
===

##

### feature groups

```{r echo=FALSE}
showButton <- function(jsFunc, arg1, arg2) sprintf("<button onclick=\"%s('%s', '%s');\" style=\"padding: 0px 3px 0px 3px\">show</button>", jsFunc, arg1, arg2)

compFGroups <- compsClustFGroups <- formFGroups <- componentFGroups <- character()
if (!is.null(rmdVars$compounds))
{
    compTable <- compoundTable(rmdVars$compounds)
    compFGroups <- rmdVars$groupNames[sapply(rmdVars$groupNames,
                                             function(grp) !is.null(compTable[[grp]]) && nrow(compTable[[grp]]) > 0)]
}
if (!is.null(rmdVars$compsCluster))
{
    cl <- clusters(rmdVars$compsCluster)
    compsClustFGroups <- rmdVars$groupNames[rmdVars$groupNames %in% names(cl)]
}
if (!is.null(rmdVars$formConsensus))
{
    formTable <- formulaTable(rmdVars$formConsensus)[byMSMS == TRUE]
    formFGroups <- unique(formTable$group)
    formFGroups <- formFGroups[formFGroups %in% rmdVars$groupNames]
}
if (!is.null(rmdVars$components))
{
    cTable <- componentTable(rmdVars$components)
    componentFGroups <- unique(unlist(sapply(cTable, "[[", "group")))
    componentFGroups <- componentFGroups[componentFGroups %in% rmdVars$groupNames]
}
plotGroups <- unique(c(compFGroups, compsClustFGroups, formFGroups))
allGroups <- unique(c(plotGroups, componentFGroups))

fGroupsSpecDT <- data.table(group = allGroups, rt = round(rmdVars$gInfo[allGroups, "rts"], 2),
                            mz = round(rmdVars$gInfo[allGroups, "mzs"], 5))

if (length(compFGroups))
    fGroupsSpecDT[group %in% compFGroups, compound := showButton("showAnnotation", match(group, allGroups), "comp")]
if (length(compsClustFGroups))
    fGroupsSpecDT[group %in% compsClustFGroups, compoundsCluster := showButton("showAnnotation",
                                                                               match(group, allGroups), "compscl")]
if (length(formFGroups))
    fGroupsSpecDT[group %in% formFGroups, formula := showButton("showAnnotation", match(group, allGroups), "form")]
if (length(componentFGroups))
{
    fGroupsSpecDT[group %in% componentFGroups, component := sapply(group, function(grp)
    {
        cmpIds <- findFGroup(rmdVars$components, grp)
        cmpNames <- tolower(names(rmdVars$components)[cmpIds]) # NOTE: headings are automatically made lowercase
        showButton("showComponentSpec", cmpNames[1], "feature-groups") # UNDONE: multiple indices
    })]
}

DT::datatable(fGroupsSpecDT, options = list(paging = FALSE, scrollY = "200px"), escape = FALSE)
```

####

<div id="noAnnotationSelected">Push a **show** button to view annotation data for a feature group.</div>

```{r allCompPlots, fig.keep='none', eval=length(plotGroups) > 0}
# Generate all plots in advance, since having many code chunks will cause a lot of overhead.

message("Generating spectra...")
prog <- txtProgressBar(0, length(plotGroups), style = 3, file = stderr())

allPlots <- vector("character", 0)
plotPath <- getPlotPath()
for (grpi in seq_along(plotGroups))
{
    plotf <- file.path(plotPath, sprintf("eic_%i.png", grpi))
    allPlots[length(allPlots) + 1] <- plotf
    makePlot(plotf, 8, 4.5,
             plotEIC(rmdVars$fGroups[, plotGroups[grpi]], rmdVars$EICRtWindow,
                     rmdVars$EICMzWindow, rmdVars$retMin,
                     rmdVars$EICTopMost, rmdVars$EICs, colourBy = "rGroup"))
    
    if (plotGroups[grpi] %in% compFGroups)
    {
        allPlots <- c(allPlots, sapply(seq_len(nrow(compTable[[plotGroups[grpi]]])), function(compi)
        {
            ret <- file.path(plotPath, sprintf("compscore_%d_%d.png", grpi, compi))
            makePlot(ret, 3, 4.5, plotScores(rmdVars$compounds, compi, plotGroups[grpi]))
            return(ret)
        }))

        allPlots <- c(allPlots, sapply(seq_len(nrow(compTable[[plotGroups[grpi]]])), function(compi)
        {
            ret <- file.path(plotPath, sprintf("compspec_%d_%d.png", grpi, compi))
            makePlot(ret, 6, 4.5, plotSpec(rmdVars$compounds, compi,  plotGroups[grpi],
                                           rmdVars$MSPeakLists, rmdVars$formConsensus,
                                           rmdVars$compoundNormalizeScores))
            return(ret)
        }))
    }
    
    if (plotGroups[grpi] %in% compsClustFGroups)
    {
        plotf <- file.path(plotPath, sprintf("dendro_%d.png", grpi))
        makePlot(plotf, 8, 4.5, plot(rmdVars$compsCluster, groupName = plotGroups[grpi]))
        allPlots <- c(allPlots, plotf)
        
        ct <- cutClusters(rmdVars$compsCluster)[[plotGroups[grpi]]]
        allPlots <- c(allPlots, sapply(seq_along(unique(ct)), function(cli)
        {
            ret <- file.path(plotPath, sprintf("mcs_%d_%d.png", grpi, cli))
            makePlot(ret, 3, 3, plotStructure(rmdVars$compsCluster, plotGroups[grpi], cli,
                                              100, 100))
            return(ret)
        }))
    }
    
    if (plotGroups[grpi] %in% formFGroups)
    {
        precursors <- unique(formTable[group == plotGroups[grpi], formula])
        allPlots <- c(allPlots, sapply(precursors, function(prec)
        {
            ret <- file.path(plotPath, sprintf("formspec_%d_%s.png", grpi, prec))
            makePlot(ret, 6, 4.5, plotSpec(rmdVars$formConsensus, prec, plotGroups[grpi], rmdVars$MSPeakLists))
            return(ret)
        }))
    }
    
    setTxtProgressBar(prog, grpi)
}
close(prog)

if (rmdVars$optimizePng && length(allPlots > 0))
    optimizePngPlots(allPlots, stderr(), rmdVars$maxProcAmount)
```

```{r echo=FALSE, eval=length(plotGroups) > 0}
rmdTexts <- vector("character", length = length(plotGroups))

message("Generating annotation layout...")
prog <- txtProgressBar(0, length(plotGroups), style = 3, file = stderr())
compSpecTempl <- readAllFile(system.file("templates", "comp-spectra.Rmd", package = "patRoon"))
compClustTempl <- readAllFile(system.file("templates", "comp-cluster.Rmd", package = "patRoon"))
formSpecTempl <- readAllFile(system.file("templates", "formula-spectra.Rmd", package = "patRoon"))

if (!is.null(rmdVars$compsCluster))
    cutcl <- cutClusters(rmdVars$compsCluster)

for (grpi in seq_along(plotGroups))
{
    rmdTexts[grpi] <- glue::glue("

## {{ .annotationClass .EIC-{ grpi } }}

### EIC {{ .annotationClass .EIC-{ grpi } }}

![]({ plotPath }/eic_{ grpi }.png)

", grpi = grpi, plotPath = plotPath)

    if (plotGroups[grpi] %in% compFGroups)
    {
        compsSeq <- seq_len(nrow(compTable[[plotGroups[grpi]]]))

        cInfos <- sapply(compsSeq, function(compi)
        {
            ret <- paste0(getCompInfoList(compTable[[plotGroups[grpi]]], compi, TRUE,
                                          mergedCompoundNames(rmdVars$compounds)), collapse = "<br>")
            if (!is.null(rmdVars$compsCluster) && !is.null(cutcl[[plotGroups[grpi]]]))
                ret <- paste(ret, sprintf("cluster: %d", cutcl[[plotGroups[grpi]]][compi]), sep = "<br>")
            return(ret)
        })
        
        rmdTexts[grpi] <- paste(rmdTexts[grpi], paste0(glue::glue(compSpecTempl, grpi = grpi,
                                                                  compi = compsSeq,
                                                                  plotPath = plotPath,
                                                                  cInfo = cInfos),
                                                       collapse = "\n"), sep = "\n")
    }
    
    if (plotGroups[grpi] %in% compsClustFGroups)
    {
        ct <- cutClusters(compsCluster)[[plotGroups[grpi]]]
        rmdTexts[grpi] <-
            paste(rmdTexts[grpi],
                  paste0(glue::glue(compClustTempl, grpi = grpi,
                                    grp = plotGroups[grpi],
                                    plotPath = plotPath,
                                    mcs = paste0(glue::glue("![]({ plotPath }/mcs_{ grpi }_{ cli }.png)",
                                                            grpi = grpi, cli = seq_len(length(unique(ct)))),
                                                 collapse = "\n")),
                         collapse = "\n"), sep = "\n")
    }
    
    if (plotGroups[grpi] %in% formFGroups)
    {
        precursors <- unique(formTable[group == plotGroups[grpi], formula])
        rmdTexts[grpi] <- paste(rmdTexts[grpi], paste0(glue::glue(formSpecTempl, grpi = grpi,
                   precursor = precursors, plotPath = plotPath,
                   fil = sapply(precursors,
                                function(prec) paste0(getFormInfoList(rmdVars$formConsensus, prec, plotGroups[grpi]),
                                collapse = "<br>"))), collapse = "\n"), sep = "\n")
    }
    
    # rmdTexts[grpi] <- knitr::knit(text = rmdTexts[grpi])
    setTxtProgressBar(prog, grpi)
}

rmdText <- paste0(rmdTexts, collapse = "\n")
close(prog)
```

<!-- stuff everything together: https://stackoverflow.com/a/21730473 -->
`r if (length(plotGroups) > 0) rmdText`
