<script>`r readAllFile(system.file("js", "utils-report.js", package = "patRoon"))`</script>

Annotation {data-orientation=rows}
===

##

### feature groups { data-width=300 }

```{r echo=FALSE}
compFGroups <- compsClustFGroups <- formFGroups <- componentFGroups <- mfWebFGroups <- character()
if (!is.null(rmdVars$compounds))
{
    compTable <- compoundTable(rmdVars$compounds)
    compFGroups <- rmdVars$groupNames[sapply(rmdVars$groupNames,
                                             function(grp) !is.null(compTable[[grp]]) && nrow(compTable[[grp]]) > 0)]
}
if (!is.null(rmdVars$compsCluster))
{
    cl <- clusters(rmdVars$compsCluster)
    compsClustFGroups <- rmdVars$groupNames[rmdVars$groupNames %in% names(cl)]
}
if (rmdVars$includeMFWebLinks != "none")
{
    if (rmdVars$includeMFWebLinks == "compounds")
        mfWebFGroups <- compFGroups
    else if (rmdVars$includeMFWebLinks == "MSMS")
        mfWebFGroups <- rmdVars$groupNames[sapply(rmdVars$groupNames,
                                                  function(grp) any(sapply(peakLists(rmdVars$MSPeakLists),
                                                                           function(pa) !is.null(pa[[grp]]) &&
                                                                               !is.null(pa[[grp]][["MSMS"]]))),
                                                  USE.NAMES = FALSE)]
    mfWebLinks <- sapply(mfWebFGroups, function(grp)
    {
        if (grp %in% compFGroups && is(rmdVars$compounds, "compoundsMF"))
        {
            # make link with used MF settings
            set <- settings(compounds)
        }
        else
            set <- NULL
        
        return(buildMFLandingURL(set, rmdVars$MSPeakLists[[grp]][["MSMS"]],
                                 rmdVars$gInfo[grp, "mzs"]))
    })
}
if (!is.null(rmdVars$formulas) && "formulas" %in% rmdVars$reportPlots)
{
    formFGroups <- groupNames(rmdVars$formulas)
    formFGroups <- formFGroups[sapply(formFGroups, function(grp) any(rmdVars$formulas[[grp]]$byMSMS))]
    formFGroups <- intersect(formFGroups, rmdVars$groupNames)
}
if (!is.null(rmdVars$components))
{
    cTable <- componentTable(rmdVars$components)
    componentFGroups <- unique(unlist(sapply(cTable, "[[", "group")))
    componentFGroups <- componentFGroups[componentFGroups %in% rmdVars$groupNames]
}
plotGroups <- unique(c(compFGroups, compsClustFGroups, formFGroups))
allGroups <- unique(c(plotGroups, componentFGroups, mfWebFGroups))

fGroupsSpecDT <- data.table(group = allGroups, rt = round(rmdVars$gInfo[allGroups, "rts"], 2),
                            mz = round(rmdVars$gInfo[allGroups, "mzs"], 5))

showButton <- function(title, jsFunc, ...)
{
    args <- paste0("'", unlist(list(...)), "'", collapse = ", ")
    sprintf("<button onclick=\"%s(%s);\" style=\"padding: 0px 3px 0px 3px\">%s</button>", jsFunc, args, title)
}
maybeAddButton <- function(grpi, subGroups, ...) if (allGroups[grpi] %in% subGroups) showButton(...) else "^"

compButtons <- sapply(seq_along(allGroups), function(gi) maybeAddButton(gi, compFGroups, "compounds", "showAnnotation", gi, "compounds"))
compCLButtons <- sapply(seq_along(allGroups), function(gi) maybeAddButton(gi, compsClustFGroups,
                                                                          "compounds clust", "showCompoundsCluster", gi))
formButtons <- sapply(seq_along(allGroups), function(gi) maybeAddButton(gi, formFGroups, "formulas",
                                                                        "showAnnotation", gi, "formulas"))
mfWebButtons <- sapply(seq_along(allGroups), function(gi) maybeAddButton(gi, mfWebFGroups, "MetFrag web",
                                                                         "window.open", mfWebLinks[allGroups[gi]], "_blank"))

sp <- paste0(rep("&nbsp;", 4), collapse = "")
buttons <- paste(compButtons, compCLButtons, formButtons, mfWebButtons, sep = sp)
buttons <- gsub("\\^(&nbsp;)*", "", buttons) # remove placeholder (^) with accompanying spaces
fGroupsSpecDT[, show := buttons]

if (!is.null(rmdVars$components))
{
    annCols <- c("isogroup", "isonr", "charge", "ppm", # RAMClustR
                 "isotopes", "adnr", "adduct_rule", "adduct_charge", "adduct_nmol", "M_adduct", # CAMERA
                 "adduct_ion", # RC/CAMERA
                 "hsnr", "rGroup") # nontarget
    
    fGroupsSpecDT[, components := sapply(group, function(grp)
    {
        cmps <- findFGroup(rmdVars$components, grp)
        if (length(cmps) == 0)
            return("")
        
        return(wrapStr(paste0(sapply(cmps, function(cmpi)
        {
            cline <- cTable[[cmpi]][group == grp]
            cline <- cline[, sapply(cline, function(x) !is.na(x) && nzchar(x),
                                    USE.NAMES = FALSE), with = FALSE]
            annColsPresent <- annCols[annCols %in% names(cline)]
            cname <- names(rmdVars$components)[cmpi]
            
            if (length(annColsPresent) > 0)
            {
                cline <- cline[, annColsPresent, with = FALSE]
                for (j in seq_along(cline))
                {
                    if (is.numeric(cline[[j]]))
                        set(cline, 1L, j, round(cline[[j]], 5))
                }
                ann <- paste0(sprintf("%s: %s", names(cline), cline), collapse = ", ")
                return(sprintf("%s (%s)", cname, ann))
            }
            return(cname)
        }), collapse = ", "), width = 50, sep = "<br>"))
    }, USE.NAMES = FALSE)]
}

DT::datatable(fGroupsSpecDT,
              options = list(paging = FALSE, scrollY = "200px", autoWidth = TRUE,
                             initComplete = DT::JS("function(settings, json)",
                                                   "{ setTimeout(initAnnotation, 25); }"),
                             order = list(list(0, "asc"))),
              escape = FALSE, rownames = FALSE, elementId = "fGroupsTable")
```

### EIC { data-width=100 }

<img id=EIC style="display:none;"></img>
<div id=noAnnotationSelected>Push a **show** button to view annotation data for a feature group.</div>


```{r allCompPlots, fig.keep='none', eval=length(plotGroups) > 0}
# Generate all plots in advance, since having many code chunks will cause a lot of overhead.

message("Generating spectra...")
prog <- txtProgressBar(0, length(plotGroups), style = 3, file = stderr())

allPlots <- vector("character", 0)
plotPathFull <- getPlotPath(FALSE)
plotPathLink <- getPlotPath(TRUE)
for (grpi in seq_along(plotGroups))
{
    plotf <- file.path(plotPathFull, sprintf("eic_%i.png", grpi))
    allPlots[length(allPlots) + 1] <- plotf
    makePlot(plotf, 5, 4.5,
             plotEIC(rmdVars$fGroups[, plotGroups[grpi]], rmdVars$EICRtWindow,
                     rmdVars$EICMzWindow, rmdVars$retMin,
                     rmdVars$EICTopMost, rmdVars$EICs, colourBy = "rGroup", title = ""))
    
    if (plotGroups[grpi] %in% compFGroups)
    {
        compsSeq <- seq_len(nrow(compTable[[plotGroups[grpi]]]))
        allPlots <- c(allPlots, sapply(compsSeq, function(compi)
        {
            ret <- file.path(plotPathFull, sprintf("compscore_%d_%d.png", grpi, compi))
            makePlot(ret, 4.5, 4.5, bg = NA,
                     plotScores(rmdVars$compounds, compi, plotGroups[grpi], rmdVars$compoundNormalizeScores,
                                rmdVars$compoundExclNormScores, rmdVars$compoundOnlyUsedScorings))
            return(ret)
        }))

        allPlots <- c(allPlots, sapply(compsSeq, function(compi)
        {
            ret <- file.path(plotPathFull, sprintf("compspec_%d_%d.png", grpi, compi))
            makePlot(ret, 7, 4.5, bg = NA, plotSpec(rmdVars$compounds, compi,  plotGroups[grpi],
                                                    rmdVars$MSPeakLists, rmdVars$formulas,
                                                    FALSE))
            return(ret)
        }))
        
        allPlots <- c(allPlots, sapply(compsSeq, function(compi)
        {
            ret <- file.path(plotPathFull, sprintf("compstruct_%d_%d.png", grpi, compi))
            makePlot(ret, 3, 3, bg = NA, plotStructure(rmdVars$compounds, compi, plotGroups[grpi], width = 150, height = 150))
            return(ret)
        }))
    }
    
    if (plotGroups[grpi] %in% compsClustFGroups)
    {
        plotf <- file.path(plotPathFull, sprintf("dendro_%d.png", grpi))
        makePlot(plotf, 8, 4.5, plot(rmdVars$compsCluster, groupName = plotGroups[grpi]))
        allPlots <- c(allPlots, plotf)
        
        ct <- cutClusters(rmdVars$compsCluster)[[plotGroups[grpi]]]
        allPlots <- c(allPlots, sapply(seq_along(unique(ct)), function(cli)
        {
            ret <- file.path(plotPathFull, sprintf("mcs_%d_%d.png", grpi, cli))
            makePlot(ret, 3, 3, plotStructure(rmdVars$compsCluster, plotGroups[grpi], cli,
                                              100, 100))
            return(ret)
        }))
    }
    
    if (plotGroups[grpi] %in% formFGroups)
    {
        precursors <- unique(rmdVars$formulas[[plotGroups[grpi]]][byMSMS == TRUE, formula])
        allPlots <- c(allPlots, sapply(precursors, function(prec)
        {
            ret <- file.path(plotPathFull, sprintf("formspec_%d_%s.png", grpi, prec))
            makePlot(ret, 6, 4.5, plotSpec(rmdVars$formulas, prec, plotGroups[grpi], MSPeakLists = rmdVars$MSPeakLists))
            return(ret)
        }))
    }
    
    setTxtProgressBar(prog, grpi)
}
close(prog)

if (rmdVars$optimizePng && length(allPlots > 0))
    optimizePngPlots(allPlots, stderr(), rmdVars$maxProcAmount)
```


```{r echo=FALSE, eval=length(plotGroups) > 0}
paths <- file.path(plotPathLink, sprintf("eic_%d.png", seq_along(plotGroups)))
if (rmdVars$selfContained)
    paths <- sapply(paths, knitr::image_uri)

# stuff everything together: https://stackoverflow.com/a/21730473
rmdText <- sprintf("<script>var EICPaths = [ %s ];</script>",
                   paste0("'", paths, "'", collapse = ", "))
```

`r if (length(plotGroups) > 0) rmdText`


## { .annotationClass .compounds }

### { .annotationClass .compounds }

<style> .compounds { overflow-x: auto; } </style>

```{r echo=FALSE, eval=length(compFGroups) > 0}
compoundsDT <- rbindlist(lapply(compFGroups, function(grp)
{
    grpi <- which(plotGroups == grp)
    mn <- mergedCompoundNames(rmdVars$compounds)

    ct <- compTable[[grp]]
    
    sppaths <- file.path(plotPathLink, sprintf("compspec_%d_%d.png", grpi, seq_len(nrow(ct))))
    scpaths <- file.path(plotPathLink, sprintf("compscore_%d_%d.png", grpi, seq_len(nrow(ct))))
    stpaths <- file.path(plotPathLink, sprintf("compstruct_%d_%d.png", grpi, seq_len(nrow(ct))))
        
    if (rmdVars$selfContained)
    {
        sppaths <- sapply(sppaths, knitr::image_uri)
        scpaths <- sapply(scpaths, knitr::image_uri)
        stpaths <- sapply(stpaths, knitr::image_uri)
    }
    
    infoTexts <- sapply(seq_len(nrow(ct)),
                        function(compi) paste0(getCompInfoList(ct, compi, TRUE, mn), collapse = "<br>"))
    infoTexts <- sprintf("<div style='max-width: 300px; max-height: 432px; border: 1px solid black; border-style: dotted; margin: 1px; padding: 1px; overflow: auto; white-space: nowrap; }'>%s</div>", infoTexts)
    
    fiTables <- sapply(ct$fragInfo, function(fi)
    {
        if (is.null(fi) || nrow(fi) == 0)
            return("")
        fi <- fi[, -"PLIndex"]
        if (!is.null(fi[["mergedBy"]]))
            fi[, mergedBy := sapply(mergedBy, function(mb) paste0(unlist(mb), collapse = ", "))]
        knitr::kable(fi, "html") %>%
                           kableExtra::kable_styling(font_size = 11) %>%
                           kableExtra::scroll_box(extra_css = "overflow: auto; height: 125px;")
    })
    
    return(data.table(group = grpi,
                      "#" = seq_len(nrow(ct)),
                      compound = paste0(imgTags(stpaths), "<br>", infoTexts),
                      spectrum = paste0(imgTags(sppaths), "<br>", fiTables),
                      scores = imgTags(scpaths)))
}))

DT::datatable(compoundsDT, options = list(scrollX = TRUE, scrollY = "600px", deferRender = TRUE,
                                          dom = "lrtp", pageLength = 25, autoWidth = TRUE,
                                          ordering = FALSE,
                                          columnDefs = list(list(visible = FALSE, targets = 0),
                                                            list(className = "dt-center", targets = 3))),
              rownames = FALSE, escape = FALSE, elementId = "compoundsTable")
```


## { .annotationClass .formulas }

### { .annotationClass .formulas }

<style> .formulas { overflow-x: auto; } </style>

```{r echo=FALSE, eval=length(formFGroups) > 0}
formulasDT <- rbindlist(lapply(formFGroups, function(grp)
{
    grpi <- which(plotGroups == grp)
    precursors <- unique(rmdVars$formulas[[grp]][byMSMS == TRUE, formula])
    
    sppaths <- file.path(plotPathLink, sprintf("formspec_%d_%s.png", grpi, precursors))
    if (rmdVars$selfContained)
        sppaths <- sapply(sppaths, knitr::image_uri)

    infoTexts <- sapply(precursors,
                        function(prec) paste0(getFormInfoList(rmdVars$formulas[[grp]], prec),
                                                              collapse = "<br>"))
    
    fiTables <- sapply(precursors, function(prec)
    {
        fi <- getFragmentInfoFromForms(rmdVars$MSPeakLists[[grp]][["MSMS"]],
                                       rmdVars$formulas[[grp]][formula == prec])[, -"PLIndex"]
        if (!is.null(fi[["mergedBy"]]))
            fi[, mergedBy := sapply(mergedBy, function(mb) paste0(unlist(mb), collapse = ", "))]
        knitr::kable(fi, "html") %>%
            kableExtra::kable_styling(font_size = 11) %>%
            kableExtra::scroll_box(extra_css = "overflow: auto; height: 125px;")
    })
    
    ret <- data.table(group = grpi,
                      spectrum = paste0(imgTags(sppaths), "<br>", fiTables),
                      info = infoTexts)

    return(ret)
}))

DT::datatable(formulasDT, options = list(scrollX = TRUE, scrollY = "600px", deferRender = TRUE,
                                         dom = "lrtp", pageLength = 25, autoWidth = TRUE,
                                         ordering = FALSE,
                                         columnDefs = list(list(visible = FALSE, targets = 0),
                                                           list(width = "300px", targets = 2))),
              rownames = FALSE, escape = FALSE, elementId = "formulasTable")

```



```{r echo=FALSE, eval=length(compsClustFGroups) > 0}
rmdTexts <- vector("character", length = length(compsClustFGroups))

message("Generating compounds cluster layout... ", appendLF = FALSE)
# prog <- txtProgressBar(0, length(plotGroups), style = 3, file = stderr())
compClustTempl <- readAllFile(system.file("templates", "comp-cluster.Rmd", package = "patRoon"))

cutcl <- cutClusters(rmdVars$compsCluster)
for (i in seq_along(compsClustFGroups))
{
    grpi <- which(plotGroups == compsClustFGroups[i])
    
    ct <- cutcl[[plotGroups[grpi]]]
    rmdTexts[i] <-
        paste0(glue::glue(compClustTempl, grpi = grpi,
                          grp = plotGroups[grpi],
                          plotPath = plotPathFull,
                          mcs = paste0(glue::glue("![]({ plotPath }/mcs_{ grpi }_{ cli }.png)",
                                                  grpi = grpi, cli = seq_len(length(unique(ct)))),
                                       collapse = "\n")),
               collapse = "\n")
}

rmdText <- paste0(rmdTexts, collapse = "\n")
message("Done!")
```

`r if (length(compsClustFGroups) > 0) rmdText`
