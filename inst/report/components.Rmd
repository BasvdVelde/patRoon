```{r echo=FALSE}
cTable <- componentTable(rmdVars$components)
cInfo <- componentInfo(rmdVars$components)
cNames <- names(rmdVars$components)
cCount <- length(rmdVars$components)

message("Plotting components...")
prog <- txtProgressBar(0, length(rmdVars$components), style = 3, file = stderr())
allPlots <- vector("character", length(rmdVars$components) * 2)
curPlotInd <- 0
plotPath <- getPlotPath()

# HACK: this should be replaced some proper inheritance/methods at some point
isHClust <- inherits(rmdVars$components, "componentsIntClust")

if (isHClust)
    clProps <- clusterProperties(rmdVars$components)

for (ci in seq_len(cCount))
{
    curPlotInd <- curPlotInd + 1
    allPlots[curPlotInd] <- file.path(plotPath, sprintf("component_spec_%d.png", ci))
    makePlot(allPlots[curPlotInd], 7, 4.5, bg = NA, plotSpec(rmdVars$components, ci,
                                   main = sprintf("ret: %.1f; m/z: %.4f - %.4f",
                                                  cInfo$ret[ci], min(cTable[[ci]]$mz), max(cTable[[ci]]$mz))))

    curPlotInd <- curPlotInd + 1
    allPlots[curPlotInd] <- file.path(plotPath, sprintf("component_eic_%d.png", ci))
    makePlot(allPlots[curPlotInd], 7, 4.5, bg = NA,
             plotEIC(rmdVars$components, ci, rmdVars$fGroups,
                     rtWindow = rmdVars$EICRtWindow,
                     mzWindow = rmdVars$EICMzWindow, retMin = rmdVars$retMin,
                     EICs = rmdVars$EICs))
    
    if (isHClust)
    {
        curPlotInd <- curPlotInd + 1
        allPlots[curPlotInd] <- file.path(plotPath, sprintf("component_int_norm_%d.png", ci))
        makePlot(allPlots[curPlotInd], 3.3, 3.3, bg = NA,
                 plotInt(rmdVars$components, index = ci, main = "normalized"))
        
        curPlotInd <- curPlotInd + 1
        allPlots[curPlotInd] <- file.path(plotPath, sprintf("component_int_abs_%d.png", ci))
        fg <- fGroups[, unique(cTable[[ci]]$group)]
        makePlot(allPlots[curPlotInd], 3.3, 3.3, bg = NA,
                 plotInt(fg, average = clProps$average, main = "absolute"))
    }
    
    setTxtProgressBar(prog, ci)
}

close(prog)

if (rmdVars$optimizePng && curPlotInd > 0)
    optimizePngPlots(allPlots, stderr(), rmdVars$maxProcAmount)
```


Components {data-orientation=rows}
===

```{r echo=FALSE,eval=isHClust}
rmdText <- knitr::knit(text = glue::glue("
##

### heatmap

{ ticks } {{r fig.width=6, fig.height=5}}
plotHeatMap(components, interactive = { inter })
{ ticks }

### dendrogram

{ ticks } {{r fig.width=6, fig.height=5}}
plot(components)
{ ticks }

", ticks = "```", inter = as.character(rmdVars$interactiveHeat)))
```
`r if (isHClust) rmdText`

## { .components }

### Components { .components }

<style> .components { overflow-x: auto; } </style>

```{r echo=FALSE}
compSeq <- seq_len(cCount)
sppaths <- file.path(plotPath, sprintf("component_spec_%d.png", compSeq))
eicpaths <- file.path(plotPath, sprintf("component_eic_%d.png", compSeq))

if (rmdVars$selfContained)
{
    sppaths <- sapply(sppaths, knitr::image_uri)
    eicpaths <- sapply(eicpaths, knitr::image_uri)
}

# clearout useless columns with only NA in them
cTable <- sapply(cTable, function(ct)
{
    ct[, sapply(ct, function(x) !all(is.na(x))), with = FALSE]
}, simplify = FALSE)
infoTables <- sapply(compSeq, function(compi) knitr::kable(cTable[[compi]], "html") %>%
                         kableExtra::kable_styling(font_size = 11) %>%
                         kableExtra::scroll_box(extra_css = "overflow: auto; width: 350px; height: 300px;"))

compTable <- data.table(component = names(rmdVars$components),
                        info = infoTables,
                        EIC = sprintf("<img src=%s></img>", eicpaths))
                             
if (isHClust)
{
    intnpaths <- file.path(plotPath, sprintf("component_int_norm_%d.png", compSeq))
    intapaths <- file.path(plotPath, sprintf("component_int_abs_%d.png", compSeq))
    
    if (rmdVars$selfContained)
    {
        intnpaths <- sapply(intnpaths, knitr::image_uri)
        intapaths <- sapply(intapaths, knitr::image_uri)
    }
    
    compTable[, intensities := sprintf("<img src=%s></img><br><img src=%s></img>", intnpaths, intapaths)]
} else
    compTable[, spectrum := sprintf("<img src=%s></img>", sppaths)]

DT::datatable(compTable, options = list(scrollX = TRUE, scrollY = "800px", deferRender = TRUE,
                                        dom = "lrtip", pageLength = 25, autoWidth = FALSE,
                                        ordering = FALSE),
              class = "striped row-border",
              rownames = FALSE, escape = FALSE)
```
